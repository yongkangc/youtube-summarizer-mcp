#!/bin/bash
# YouTube Transcript Summarizer
# Usage: yt-summarize <youtube_url>
# Alias: yt-s

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Clipboard functions for cross-platform support
clipboard_paste() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        pbpaste
    elif command -v xsel &> /dev/null; then
        xsel --clipboard --output
    elif command -v xclip &> /dev/null; then
        xclip -selection clipboard -o
    elif command -v wl-paste &> /dev/null; then
        wl-paste
    else
        echo "Error: No clipboard utility found" >&2
        exit 1
    fi
}

clipboard_copy() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        pbcopy
    elif command -v xsel &> /dev/null; then
        xsel --clipboard --input
    elif command -v xclip &> /dev/null; then
        xclip -selection clipboard
    elif command -v wl-copy &> /dev/null; then
        wl-copy
    else
        echo "Error: No clipboard utility found" >&2
        exit 1
    fi
}

if [ $# -eq 0 ]; then
    echo "Usage: yt-summarize <youtube_url>" >&2
    echo "Example: yt-summarize https://www.youtube.com/watch?v=Y7dwbJ0AtUA" >&2
    exit 1
fi

YOUTUBE_URL="$1"

echo "ðŸ“º Fetching transcript from YouTube..." >&2

# Create temporary file for transcript
TRANSCRIPT_FILE=$(mktemp)
trap "rm -f $TRANSCRIPT_FILE" EXIT

# Fetch transcript - save to temp file instead of clipboard
if ! (cd "$SCRIPT_DIR/.." && export PATH="$HOME/.local/bin:$PATH" && uv run python main.py "$YOUTUBE_URL") > "$TRANSCRIPT_FILE" 2>&1; then
    echo "âŒ Failed to fetch transcript" >&2
    cat "$TRANSCRIPT_FILE" >&2
    exit 1
fi

echo "ðŸ¤– Generating summary with Claude..." >&2

# Read the prompt template
PROMPT=$(cat "$SCRIPT_DIR/../prompts/summarize_prompt.md")

# Use Claude to summarize the transcript
# Pass transcript via stdin to avoid "Argument list too long" error
SUMMARY=$(cat "$TRANSCRIPT_FILE" | claude -p "$PROMPT

YouTube URL: $YOUTUBE_URL")

if [ $? -eq 0 ]; then
    # Try to copy summary to clipboard (optional - may fail in headless environments)
    if echo "$SUMMARY" | clipboard_copy 2>/dev/null; then
        echo "" >&2
        echo "âœ… Summary generated and copied to clipboard!" >&2
    else
        echo "" >&2
        echo "âœ… Summary generated!" >&2
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "" >&2

    # Display the summary
    echo "$SUMMARY"

    # Use Claude to generate a clean filename from the summary content
    FILENAME=$(echo "$SUMMARY" | claude -p "Based on this video summary, generate a concise, descriptive filename (without .md extension). Use lowercase letters, numbers, and underscores only. Make it descriptive but not too long (max 60 chars). Only output the filename, nothing else." | tr -d '\n' | sed 's/[^a-z0-9_]/_/g' | sed 's/__*/_/g' | sed 's/^_//;s/_$//')

    # Add .md extension
    FILENAME="${FILENAME}.md"

    # Use Claude to determine the category
    CATEGORY=$(echo "$SUMMARY" | claude -p "Based on this video summary, classify it into exactly ONE of these categories: ai, trading, self-help, career, programming, investments. Only output the single category word, nothing else." | tr -d '\n' | tr '[:upper:]' '[:lower:]')

    # Validate category - default to 'misc' if not recognized
    case "$CATEGORY" in
        ai|trading|self-help|career|programming|investments)
            ;;
        *)
            CATEGORY="misc"
            ;;
    esac

    # Extract title from summary for commit message (first line starting with #)
    TITLE=$(echo "$SUMMARY" | grep -m 1 '^#' | sed 's/^#* *//' | head -1 || echo "Video Summary")

    echo "" >&2
    echo "ðŸ“ Category: $CATEGORY" >&2
    echo "ðŸ’¾ Auto-generated filename: $FILENAME" >&2

    SUMMARIES_DIR="$SCRIPT_DIR/../summaries"
    CATEGORY_DIR="$SUMMARIES_DIR/$CATEGORY"

    # Create category directory if it doesn't exist
    mkdir -p "$CATEGORY_DIR"

    FILE_PATH="$CATEGORY_DIR/$FILENAME"

    # Save summary to file
    echo "$SUMMARY" > "$FILE_PATH"
    echo "âœ… Saved to: $FILE_PATH" >&2

    # Commit and push
    echo "ðŸ“¤ Committing and pushing to git..." >&2
    cd "$SUMMARIES_DIR"
    git add "$CATEGORY/$FILENAME"

    # Generate commit message from title
    COMMIT_MSG="Add summary: $TITLE"
    git commit -m "$COMMIT_MSG"

    # Pull before pushing to avoid conflicts
    git pull --rebase
    git push

    echo "âœ… Committed and pushed!" >&2

    # Generate GitHub link to the file
    REMOTE_URL=$(git remote get-url origin)
    # Extract owner/repo from git URL (handles both SSH and HTTPS)
    REPO_PATH=$(echo "$REMOTE_URL" | sed 's/.*github\.com[:/]\(.*\)\.git$/\1/' | sed 's/.*github\.com[:/]\(.*\)$/\1/')
    BRANCH=$(git rev-parse --abbrev-ref HEAD)
    GITHUB_URL="https://github.com/${REPO_PATH}/blob/${BRANCH}/summaries/${CATEGORY}/${FILENAME}"

    echo "" >&2
    echo "ðŸ”— View on GitHub:" >&2
    echo "$GITHUB_URL"
else
    echo "âŒ Failed to generate summary" >&2
    exit 1
fi
