#!/bin/bash
# YouTube Transcript Summarizer
# Usage: yt-summarize <youtube_url>
# Alias: yt-s

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ $# -eq 0 ]; then
    echo "Usage: yt-summarize <youtube_url>" >&2
    echo "Example: yt-summarize https://www.youtube.com/watch?v=Y7dwbJ0AtUA" >&2
    exit 1
fi

YOUTUBE_URL="$1"

echo "ðŸ“º Fetching transcript from YouTube..." >&2

# Fetch transcript using the yt script (copies to clipboard)
if ! "$SCRIPT_DIR/yt" "$YOUTUBE_URL"; then
    echo "âŒ Failed to fetch transcript" >&2
    exit 1
fi

echo "ðŸ¤– Generating summary with Claude..." >&2

# Read transcript from clipboard
TRANSCRIPT=$(pbpaste)

# Read the prompt template
PROMPT=$(cat "$SCRIPT_DIR/../prompts/summarize_prompt.md")

# Use Claude to summarize the transcript
SUMMARY=$(echo "$TRANSCRIPT" | claude -p "$PROMPT

Transcript:
$TRANSCRIPT")

if [ $? -eq 0 ]; then
    # Copy summary to clipboard
    echo "$SUMMARY" | pbcopy

    echo "" >&2
    echo "âœ… Summary generated and copied to clipboard!" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "" >&2

    # Display the summary
    echo "$SUMMARY"

    # Extract video ID from URL
    VIDEO_ID=$(echo "$YOUTUBE_URL" | sed -n 's/.*[?&]v=\([^&]*\).*/\1/p')
    if [ -z "$VIDEO_ID" ]; then
        VIDEO_ID=$(echo "$YOUTUBE_URL" | sed -n 's/.*youtu\.be\/\([^?]*\).*/\1/p')
    fi

    # Prompt for filename
    echo "" >&2
    echo "ðŸ’¾ Save to summaries folder?" >&2
    echo "Enter filename (without .md extension), or press Enter to skip:" >&2
    read -r FILENAME

    if [ -n "$FILENAME" ]; then
        # Add .md extension if not present
        if [[ ! "$FILENAME" =~ \.md$ ]]; then
            FILENAME="${FILENAME}.md"
        fi

        SUMMARIES_DIR="$SCRIPT_DIR/../summaries"
        FILE_PATH="$SUMMARIES_DIR/$FILENAME"

        # Save summary to file
        echo "$SUMMARY" > "$FILE_PATH"
        echo "âœ… Saved to: $FILE_PATH" >&2

        # Commit and push
        echo "ðŸ“¤ Committing and pushing to git..." >&2
        cd "$SUMMARIES_DIR"
        git add "$FILENAME"

        # Generate commit message
        COMMIT_MSG="Add summary: $FILENAME"
        git commit -m "$COMMIT_MSG"
        git push

        echo "âœ… Committed and pushed!" >&2
    else
        echo "â­ï¸  Skipped saving to file" >&2
    fi
else
    echo "âŒ Failed to generate summary" >&2
    exit 1
fi
