#!/bin/bash
# YouTube Transcript Summarizer
# Usage: yt-summarize <youtube_url>
# Alias: yt-s

set -e

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

if [ $# -eq 0 ]; then
    echo "Usage: yt-summarize <youtube_url>" >&2
    echo "Example: yt-summarize https://www.youtube.com/watch?v=Y7dwbJ0AtUA" >&2
    exit 1
fi

YOUTUBE_URL="$1"

echo "ðŸ“º Fetching transcript from YouTube..." >&2

# Fetch transcript using the yt script (copies to clipboard)
if ! "$SCRIPT_DIR/yt" "$YOUTUBE_URL"; then
    echo "âŒ Failed to fetch transcript" >&2
    exit 1
fi

echo "ðŸ¤– Generating summary with Claude..." >&2

# Read transcript from clipboard
TRANSCRIPT=$(pbpaste)

# Read the prompt template
PROMPT=$(cat "$SCRIPT_DIR/../prompts/summarize_prompt.md")

# Use Claude to summarize the transcript
SUMMARY=$(echo "$TRANSCRIPT" | claude -p "$PROMPT

YouTube URL: $YOUTUBE_URL

Transcript:
$TRANSCRIPT")

if [ $? -eq 0 ]; then
    # Copy summary to clipboard
    echo "$SUMMARY" | pbcopy

    echo "" >&2
    echo "âœ… Summary generated and copied to clipboard!" >&2
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    echo "" >&2

    # Display the summary
    echo "$SUMMARY"

    # Use Claude to generate a clean filename from the summary content
    FILENAME=$(echo "$SUMMARY" | claude -p "Based on this video summary, generate a concise, descriptive filename (without .md extension). Use lowercase letters, numbers, and underscores only. Make it descriptive but not too long (max 60 chars). Only output the filename, nothing else." | tr -d '\n' | sed 's/[^a-z0-9_]/_/g' | sed 's/__*/_/g' | sed 's/^_//;s/_$//')

    # Add .md extension
    FILENAME="${FILENAME}.md"

    # Extract title from summary for commit message (first line starting with #)
    TITLE=$(echo "$SUMMARY" | grep -m 1 '^#' | sed 's/^#* *//' | head -1 || echo "Video Summary")

    echo "" >&2
    echo "ðŸ’¾ Auto-generated filename: $FILENAME" >&2

    SUMMARIES_DIR="$SCRIPT_DIR/../summaries"
    FILE_PATH="$SUMMARIES_DIR/$FILENAME"

    # Save summary to file
    echo "$SUMMARY" > "$FILE_PATH"
    echo "âœ… Saved to: $FILE_PATH" >&2

    # Commit and push
    echo "ðŸ“¤ Committing and pushing to git..." >&2
    cd "$SUMMARIES_DIR"
    git add "$FILENAME"

    # Generate commit message from title
    COMMIT_MSG="Add summary: $TITLE"
    git commit -m "$COMMIT_MSG"

    # Pull before pushing to avoid conflicts
    git pull --rebase
    git push

    echo "âœ… Committed and pushed!" >&2
else
    echo "âŒ Failed to generate summary" >&2
    exit 1
fi
