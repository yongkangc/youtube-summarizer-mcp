#!/bin/bash

# YouTube Transcript to Clipboard Script
# Cross-platform version with dependency management
# Usage: ./yt <youtube_url>

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_color() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}" >&2
}

# Check if argument is provided
if [ $# -eq 0 ]; then
    print_color "$RED" "Usage: $0 <youtube_url>"
    print_color "$YELLOW" "Example: $0 https://www.youtube.com/watch?v=1nEv_H8FDB0"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Detect Python command
if command -v python3 &> /dev/null; then
    PYTHON_CMD="python3"
elif command -v python &> /dev/null; then
    PYTHON_CMD="python"
else
    print_color "$RED" "Error: Python is not installed"
    exit 1
fi

# Check if youtube-transcript-api is installed
check_dependency() {
    $PYTHON_CMD -c "import youtube_transcript_api" 2>/dev/null
    return $?
}

# Install dependencies if needed
if ! check_dependency; then
    print_color "$YELLOW" "Installing required dependencies..."
    
    # Check if we're in a virtual environment
    if [ -n "$VIRTUAL_ENV" ]; then
        # We're in a virtual environment, install normally
        print_color "$YELLOW" "Installing in virtual environment..."
        $PYTHON_CMD -m pip install youtube-transcript-api >&2
    elif [ -f "pyproject.toml" ]; then
        # Try to install using pip with pyproject.toml
        print_color "$YELLOW" "Installing from pyproject.toml..."
        if command -v pip &> /dev/null; then
            pip install -e . --user >&2 2>/dev/null || pip install -e . >&2
        elif command -v pip3 &> /dev/null; then
            pip3 install -e . --user >&2 2>/dev/null || pip3 install -e . >&2
        else
            $PYTHON_CMD -m pip install -e . --user >&2 2>/dev/null || $PYTHON_CMD -m pip install -e . >&2
        fi
    else
        # Try user installation first, fall back to system if that fails
        print_color "$YELLOW" "Installing youtube-transcript-api..."
        if ! $PYTHON_CMD -m pip install --user youtube-transcript-api >&2 2>/dev/null; then
            # Try without --user flag (for systems that don't need it)
            if ! $PYTHON_CMD -m pip install youtube-transcript-api >&2 2>/dev/null; then
                # Last resort: try with break-system-packages for newer Python
                if ! $PYTHON_CMD -m pip install --user --break-system-packages youtube-transcript-api >&2 2>/dev/null; then
                    print_color "$RED" "Failed to install automatically."
                    print_color "$YELLOW" "Please install manually using one of these methods:"
                    print_color "$YELLOW" "1. Create a virtual environment:"
                    print_color "$YELLOW" "   python3 -m venv venv"
                    print_color "$YELLOW" "   source venv/bin/activate"
                    print_color "$YELLOW" "   pip install youtube-transcript-api"
                    print_color "$YELLOW" ""
                    print_color "$YELLOW" "2. Install with pipx:"
                    print_color "$YELLOW" "   brew install pipx"
                    print_color "$YELLOW" "   pipx install youtube-transcript-api"
                    print_color "$YELLOW" ""
                    print_color "$YELLOW" "3. Install with Homebrew (if available):"
                    print_color "$YELLOW" "   brew install youtube-transcript-api"
                    exit 1
                fi
            fi
        fi
    fi
    
    # Check again after installation
    if ! check_dependency; then
        print_color "$RED" "Failed to install dependencies."
        print_color "$YELLOW" "Please install manually: pip install youtube-transcript-api"
        exit 1
    fi
    
    print_color "$GREEN" "Dependencies installed successfully!"
fi

# Function to copy to clipboard based on OS
copy_to_clipboard() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        pbcopy
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux
        if command -v xclip &> /dev/null; then
            xclip -selection clipboard
        elif command -v xsel &> /dev/null; then
            xsel --clipboard --input
        elif command -v wl-copy &> /dev/null; then
            # Wayland
            wl-copy
        else
            print_color "$YELLOW" "No clipboard utility found. Install xclip, xsel, or wl-clipboard."
            print_color "$YELLOW" "Transcript printed to stdout instead."
            cat  # Just output to stdout
            return 1
        fi
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
        # Windows (Git Bash, Cygwin, WSL)
        if command -v clip.exe &> /dev/null; then
            clip.exe
        elif command -v /mnt/c/Windows/System32/clip.exe &> /dev/null; then
            # WSL specific
            /mnt/c/Windows/System32/clip.exe
        else
            print_color "$YELLOW" "Cannot access Windows clipboard. Transcript printed to stdout instead."
            cat  # Just output to stdout
            return 1
        fi
    else
        print_color "$YELLOW" "Unknown OS. Transcript printed to stdout instead."
        cat  # Just output to stdout
        return 1
    fi
    return 0
}

# Create temporary file for output
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Run the Python script and capture output
print_color "$YELLOW" "Fetching transcript..."
if (cd "$SCRIPT_DIR/.." && $PYTHON_CMD main.py "$1") > "$TEMP_FILE" 2>&1; then
    # Success - copy to clipboard
    if cat "$TEMP_FILE" | copy_to_clipboard; then
        print_color "$GREEN" "âœ… Transcript copied to clipboard!"
        
        # Show summary
        CHAR_COUNT=$(wc -c < "$TEMP_FILE")
        LINE_COUNT=$(wc -l < "$TEMP_FILE")
        print_color "$GREEN" "ðŸ“Š Stats: ${LINE_COUNT} lines, ${CHAR_COUNT} characters"
    else
        print_color "$GREEN" "âœ… Transcript fetched successfully!"
        echo "------- TRANSCRIPT -------"
        cat "$TEMP_FILE"
        echo "------- END TRANSCRIPT -------"
    fi
else
    # Error occurred
    print_color "$RED" "âŒ Failed to fetch transcript"
    if [ -s "$TEMP_FILE" ]; then
        cat "$TEMP_FILE" >&2
    fi
    exit 1
fi