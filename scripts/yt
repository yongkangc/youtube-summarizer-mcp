#!/bin/bash

# YouTube Transcript to Clipboard Script
# Cross-platform version with dependency management
# Usage: ./yt <youtube_url>

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_color() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}" >&2
}

# Check if argument is provided
if [ $# -eq 0 ]; then
    print_color "$RED" "Usage: $0 <youtube_url>"
    print_color "$YELLOW" "Example: $0 https://www.youtube.com/watch?v=1nEv_H8FDB0"
    exit 1
fi

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# Add uv to PATH if it exists
export PATH="$HOME/.local/bin:$PATH"

# Check if uv is available
if ! command -v uv &> /dev/null; then
    print_color "$RED" "Error: uv is not installed"
    print_color "$YELLOW" "Install it with: curl -LsSf https://astral.sh/uv/install.sh | sh"
    exit 1
fi

# Use uv run to execute Python with the project dependencies
PYTHON_CMD="uv run python"

# Function to copy to clipboard based on OS
copy_to_clipboard() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        pbcopy 2>/dev/null || { cat; return 1; }
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        # Linux - try clipboard utilities, fallback to stdout if no display
        if command -v xclip &> /dev/null; then
            xclip -selection clipboard 2>/dev/null || { cat; return 1; }
        elif command -v xsel &> /dev/null; then
            xsel --clipboard --input 2>/dev/null || { cat; return 1; }
        elif command -v wl-copy &> /dev/null; then
            # Wayland
            wl-copy 2>/dev/null || { cat; return 1; }
        else
            cat  # Just output to stdout
            return 1
        fi
    elif [[ "$OSTYPE" == "msys" || "$OSTYPE" == "cygwin" || "$OSTYPE" == "win32" ]]; then
        # Windows (Git Bash, Cygwin, WSL)
        if command -v clip.exe &> /dev/null; then
            clip.exe 2>/dev/null || { cat; return 1; }
        elif command -v /mnt/c/Windows/System32/clip.exe &> /dev/null; then
            # WSL specific
            /mnt/c/Windows/System32/clip.exe 2>/dev/null || { cat; return 1; }
        else
            cat  # Just output to stdout
            return 1
        fi
    else
        cat  # Just output to stdout
        return 1
    fi
    return 0
}

# Create temporary file for output
TEMP_FILE=$(mktemp)
trap "rm -f $TEMP_FILE" EXIT

# Run the Python script and capture output
print_color "$YELLOW" "Fetching transcript..."
if (cd "$SCRIPT_DIR/.." && $PYTHON_CMD main.py "$1") > "$TEMP_FILE" 2>&1; then
    # Success - copy to clipboard
    if cat "$TEMP_FILE" | copy_to_clipboard; then
        print_color "$GREEN" "âœ… Transcript copied to clipboard!"
        
        # Show summary
        CHAR_COUNT=$(wc -c < "$TEMP_FILE")
        LINE_COUNT=$(wc -l < "$TEMP_FILE")
        print_color "$GREEN" "ðŸ“Š Stats: ${LINE_COUNT} lines, ${CHAR_COUNT} characters"
    else
        print_color "$GREEN" "âœ… Transcript fetched successfully!"
        echo "------- TRANSCRIPT -------"
        cat "$TEMP_FILE"
        echo "------- END TRANSCRIPT -------"
    fi
else
    # Error occurred
    print_color "$RED" "âŒ Failed to fetch transcript"
    if [ -s "$TEMP_FILE" ]; then
        cat "$TEMP_FILE" >&2
    fi
    exit 1
fi